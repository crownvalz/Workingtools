<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Barcode Scanner</title>
    <!-- html5-qrcode CDN -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        #scanner {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #007BFF;
            color: white;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .input-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        .input-row input {
            padding: 8px;
            width: 70%;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .input-row button {
            padding: 9px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .input-row button:hover {
            background-color: #218838;
        }

        #downloadCsvBtn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #downloadCsvBtn:hover {
            background-color: #138496;
        }

        @media (max-width: 500px) {
            .input-row input {
                width: 60%;
            }
        }
    </style>
</head>
<body>
    <h1>Asset Barcode Scanner</h1>

    <div id="scanner"></div>

    <div class="input-row">
        <input type="text" id="assetNameInput" placeholder="Enter Asset Name (optional)">
        <button id="addAssetBtn">Add Asset</button>
    </div>

    <table id="assetTable">
        <thead>
            <tr>
                <th>Asset Name</th>
                <th>Barcode</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button id="downloadCsvBtn">Download CSV</button>

    <script>
        let scannedAssets = [];
        let lastScannedCode = null;

        const assetNameInput = document.getElementById('assetNameInput');
        const addAssetBtn = document.getElementById('addAssetBtn');
        const assetTableBody = document.querySelector('#assetTable tbody');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');

        function addAsset(barcode, name) {
            // Prevent duplicate barcodes
            if (scannedAssets.some(asset => asset.barcode === barcode)) {
                alert('This barcode has already been scanned.');
                return;
            }

            const timestamp = new Date().toLocaleString();
            const asset = {
                name: name || "Unknown",
                barcode,
                timestamp
            };
            scannedAssets.push(asset);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${asset.name}</td>
                <td>${asset.barcode}</td>
                <td>${asset.timestamp}</td>
            `;
            assetTableBody.appendChild(row);
        }

        addAssetBtn.addEventListener('click', () => {
            if (!lastScannedCode) {
                alert('No barcode scanned yet!');
                return;
            }
            addAsset(lastScannedCode, assetNameInput.value);
            assetNameInput.value = '';
            lastScannedCode = null;
        });

        downloadCsvBtn.addEventListener('click', () => {
            if (scannedAssets.length === 0) {
                alert('No assets to download.');
                return;
            }

            let csvContent = "Asset Name,Barcode,Timestamp\n";
            scannedAssets.forEach(asset => {
                const safeName = `"${asset.name.replace(/"/g, '""')}"`; // Handle quotes
                csvContent += `${safeName},${asset.barcode},${asset.timestamp}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "assets.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function onScanSuccess(decodedText, decodedResult) {
            // Save last scanned barcode
            lastScannedCode = decodedText;
            // Auto-fill asset name input with last scanned barcode
            assetNameInput.value = '';
        }

        function onScanError(errorMessage) {
            // Handle scan error if needed
            console.log(errorMessage);
        }

        const html5QrCode = new Html5Qrcode("scanner");

        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length) {
                const cameraId = cameras.find(cam => cam.label.toLowerCase().includes("back"))?.id || cameras[0].id;
                html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,    // Scans per second
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    onScanSuccess,
                    onScanError
                ).catch(err => console.error(err));
            }
        }).catch(err => console.error(err));
    </script>
</body>
</html>
