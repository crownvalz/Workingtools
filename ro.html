<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Dynamic Document Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <!-- Font Awesome CDN for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <style>
    /* Cropper container should be responsive and max height */
    #cropperImage {
      max-width: 100%;
      max-height: 60vh;
      display: block;
      margin: 0 auto;
    }
    /* Increase the size of ID previews */
    .id-preview {
      width: 7.5rem !important;
      height: 7.5rem !important;
      min-width: 7.5rem !important;
      min-height: 7.5rem !important;
      max-width: 10rem;
      max-height: 10rem;
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-100 via-purple-100 to-pink-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 transition-colors duration-500 min-h-screen flex flex-col">

  <!-- Responsive Navigation Bar -->
  <nav class="w-full z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-8 py-2 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="text-3xl">🧠</span>
        <span class="font-extrabold text-xl md:text-2xl text-blue-700 dark:text-purple-300 tracking-tight">MonoDocs</span>
      </div>
      <div class="hidden md:flex gap-6 items-center">
        <a href="#" class="text-gray-700 dark:text-gray-200 font-medium hover:text-blue-600 dark:hover:text-purple-300 transition">Home</a>
        <a href="#" class="text-gray-700 dark:text-gray-200 font-medium hover:text-blue-600 dark:hover:text-purple-300 transition">Features</a>
        <a href="#" class="text-gray-700 dark:text-gray-200 font-medium hover:text-blue-600 dark:hover:text-purple-300 transition">Help</a>
      </div>


            <!-- Mobile menu toggle (hidden for now) -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" class="text-2xl text-gray-700 dark:text-gray-200 focus:outline-none">&#9776;</button>
      </div>
    </div>
    <!-- Mobile menu -->
    <div id="mobileMenu" class="md:hidden hidden px-4 pb-3">
      <a href="#" class="block py-2 text-gray-700 dark:text-gray-200 font-medium hover:text-blue-600 dark:hover:text-purple-300 transition">Home</a>
      <a href="#" class="block py-2 text-gray-700 dark:text-gray-200 font-medium hover:text-blue-600 dark:hover:text-purple-300 transition">Features</a>
      <a href="#" class="block py-2 text-gray-700 dark:text-gray-200 font-medium hover:text-blue-600 dark:hover:text-purple-300 transition">Help</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center justify-center px-2 md:px-8 py-6 w-full">
    <div class="w-full max-w-5xl mx-auto bg-white/90 dark:bg-gray-900/90 shadow-2xl rounded-3xl p-4 md:p-8 lg:p-12 mt-4 md:mt-8 mb-4">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-2">
        <h2 class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-gray-200 tracking-tight text-center md:text-left">📄 Smart Document Upload</h2>
      </div>

      <!-- Upload Form -->
      <form id="uploadForm" class="space-y-8">
        <!-- Dynamic Fields -->
        <div id="uploadContainer" class="space-y-6"></div>

        <!-- Add Field Buttons -->
        <div class="flex flex-wrap justify-center gap-4">
          <button type="button" id="addPassportBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 active:scale-95 transition flex items-center gap-1 text-base font-semibold shadow-lg">
            <i class="fas fa-passport mr-1"></i> Passport
          </button>
          <button type="button" id="addIDBtn"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 active:scale-95 transition flex items-center gap-1 text-base font-semibold shadow-lg">
            <i class="fas fa-id-card mr-1"></i> ID
          </button>
          <button type="button" id="addOtherBtn"
            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 active:scale-95 transition flex items-center gap-1 text-base font-semibold shadow-lg">
            <i class="fas fa-file-alt mr-1"></i> Other
          </button>
        </div>

        <!-- Progress -->
        <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700 hidden" id="progressWrapper">
          <div class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 h-3 rounded-full transition-all duration-300" style="width: 0%" id="progressBar"></div>
        </div>

        <!-- Submit -->
        <button type="submit"
          class="w-full bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white py-3 px-4 rounded-2xl hover:from-blue-700 hover:via-purple-700 hover:to-pink-700 transition text-lg font-bold shadow-xl tracking-wide flex items-center justify-center gap-2">
          <i class="fas fa-file-pdf mr-2"></i> Generate Smart PDF
        </button>
      </form>
    </div>
  </main>

  <!-- Modal for Document Name Input -->
  <div id="nameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-xl p-6 w-11/12 max-w-md">
      <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Enter PDF File Name</h3>
      <input type="text" id="pdfFileName" placeholder="Document name" class="w-full p-3 border rounded dark:bg-gray-700 dark:text-gray-200 mb-4" />
      <div class="flex justify-end gap-4">
        <button onclick="closeNameModal()" type="button" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-600 transition">Cancel</button>
        <button onclick="submitPDF()" type="button" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition">Generate PDF</button>
      </div>
    </div>
  </div>

  <!-- Cropper Modal -->
  <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-60">
    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-xl p-4 w-11/12 max-w-3xl max-h-[80vh] flex flex-col">
      <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-200 text-center">Crop Image</h3>
      <div class="flex-1 overflow-auto">
        <img id="cropperImage" src="" alt="Cropper Image" />
      </div>
      <div class="mt-4 flex justify-end gap-4">
        <button id="cancelCropBtn" type="button" class="px-5 py-2 rounded bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-600 transition">Cancel</button>
        <button id="applyCropBtn" type="button" class="px-5 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 transition">Apply Crop</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    let fieldCount = 0;
    let cropper = null;
    let currentCropFieldId = null;

    const docTypes = [
      { value: "passport", label: "Passport Photo (Passport Size)" },
      { value: "id", label: "ID Image" },
      { value: "other", label: "Other Document/Image" }
    ];

    // Add Upload Field with optional preset type
    function addUploadField(presetType = null) {
      fieldCount++;
      const container = document.getElementById("uploadContainer");

      const fieldDiv = document.createElement("div");
      fieldDiv.className = "border rounded-2xl p-4 bg-gradient-to-br from-gray-50 via-white to-gray-100 dark:from-gray-800 dark:via-gray-900 dark:to-gray-800 relative group shadow-lg";
      fieldDiv.id = `field-${fieldCount}`;

      const optionsHTML = docTypes.map(d => {
        const selected = presetType === d.value ? "selected" : "";
        return `<option value="${d.value}" ${selected}>${d.label}</option>`;
      }).join("");

      fieldDiv.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <label class="font-semibold text-gray-700 dark:text-gray-200 tracking-wide">Document ${fieldCount}</label>
          <div class="flex gap-2">
            <button type="button" onclick="moveUp(${fieldCount})" class="text-gray-500 hover:text-blue-600 text-lg" title="Move up">⬆</button>
            <button type="button" onclick="moveDown(${fieldCount})" class="text-gray-500 hover:text-blue-600 text-lg" title="Move down">⬇</button>
            <button type="button" onclick="removeField(${fieldCount})"
              class="text-red-500 hover:text-red-700 text-lg" title="Remove">✖</button>
          </div>
        </div>
        <select id="type-${fieldCount}" class="w-full mb-3 p-3 border rounded-lg dark:bg-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-400 transition">
          ${optionsHTML}
        </select>
        <input type="file" id="file-${fieldCount}" accept="image/*,.pdf" class="hidden" required>
        <div id="drop-${fieldCount}"
          class="border-2 border-dashed border-gray-300 rounded-2xl p-8 flex flex-col items-center cursor-pointer hover:border-blue-400 transition bg-white dark:bg-gray-700 shadow-inner">
          <span class="text-gray-500 dark:text-gray-300 text-lg">📂 Click or Drag & Drop to Upload</span>
        </div>
        <div class="mt-4 flex items-center gap-4">
          <img id="preview-${fieldCount}" class="hidden id-preview object-cover rounded-xl border-2 border-blue-200 dark:border-gray-700 shadow-lg transition-all duration-200" alt="Preview"/>
          <button type="button" id="cropBtn-${fieldCount}" class="hidden px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition text-base font-semibold shadow">✂️ Crop</button>
        </div>
        <div id="filename-${fieldCount}" class="mt-2 hidden text-sm text-blue-600 break-all"></div>
      `;

      container.appendChild(fieldDiv);

      // File upload + preview
      const dropZone = document.getElementById(`drop-${fieldCount}`);
      const fileInput = document.getElementById(`file-${fieldCount}`);
      const preview = document.getElementById(`preview-${fieldCount}`);
      const filenameDiv = document.getElementById(`filename-${fieldCount}`);
      const cropBtn = document.getElementById(`cropBtn-${fieldCount}`);

      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("dragover", e => {
        e.preventDefault();
        dropZone.classList.add("border-blue-500", "bg-blue-50", "dark:bg-blue-900/30");
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("border-blue-500", "bg-blue-50", "dark:bg-blue-900/30");
      });
      dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-50", "dark:bg-blue-900/30");
        fileInput.files = e.dataTransfer.files;
        handlePreview(fileInput.files[0], fieldCount);
      });

      fileInput.addEventListener("change", e => handlePreview(e.target.files[0], fieldCount));

      // Crop button event
      cropBtn.addEventListener("click", () => {
        openCropModal(fieldCount);
      });
    }

    // Store cropped data URLs per field
    const croppedImages = {};

    function handlePreview(file, id) {
      if (!file) return;
      const preview = document.getElementById(`preview-${id}`);
      const filenameDiv = document.getElementById(`filename-${id}`);
      const cropBtn = document.getElementById(`cropBtn-${id}`);

      // Clear any previous cropped image for this field because new file loaded
      delete croppedImages[id];

      if (file.type.includes("image")) {
        const reader = new FileReader();
        reader.onload = ev => {
          preview.src = ev.target.result;
          preview.classList.remove("hidden");
          filenameDiv.classList.add("hidden");
          cropBtn.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      } else {
        filenameDiv.textContent = "📄 " + file.name;
        filenameDiv.classList.remove("hidden");
        preview.classList.add("hidden");
        cropBtn.classList.add("hidden");
      }
    }

    // Remove field
    function removeField(id) {
      const field = document.getElementById(`field-${id}`);
      if (field) {
        field.remove();
        delete croppedImages[id];
      }
    }

    // Reorder fields
    function moveUp(id) {
      const field = document.getElementById(`field-${id}`);
      if (field && field.previousElementSibling) {
        field.parentNode.insertBefore(field, field.previousElementSibling);
      }
    }
    function moveDown(id) {
      const field = document.getElementById(`field-${id}`);
      if (field && field.nextElementSibling) {
        field.parentNode.insertBefore(field.nextElementSibling, field);
      }
    }

    // Add buttons event listeners
    document.getElementById("addPassportBtn").addEventListener("click", () => addUploadField("passport"));
    document.getElementById("addIDBtn").addEventListener("click", () => addUploadField("id"));
    document.getElementById("addOtherBtn").addEventListener("click", () => addUploadField("other"));

    // Open modal instead of generating PDF immediately
    document.getElementById("uploadForm").addEventListener("submit", function (e) {
      e.preventDefault();
      document.getElementById("pdfFileName").value = "";
      document.getElementById("nameModal").classList.remove("hidden");
      document.getElementById("pdfFileName").focus();
    });

    // Close modal function
    function closeNameModal() {
      document.getElementById("nameModal").classList.add("hidden");
    }

    // Generate PDF using entered file name
    async function submitPDF() {
      const fileNameInput = document.getElementById("pdfFileName");
      let fileName = fileNameInput.value.trim();
      if (!fileName) {
        alert("Please enter a document name.");
        fileNameInput.focus();
        return;
      }
      // Sanitize filename (remove invalid characters)
      fileName = fileName.replace(/[\\/:"*?<>|]+/g, '') || "uploaded-documents";

      closeNameModal();

      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: "a4"
      });

      // Gather all fields and group by type for layouting
      const fields = [...document.getElementById("uploadContainer").children];
      let passports = [];
      let ids = [];
      let others = [];
      for (const field of fields) {
        const typeEl = field.querySelector("select");
        const fileEl = field.querySelector("input[type=file]");
        if (!fileEl || fileEl.files.length === 0) continue;
        const file = fileEl.files[0];
        const id = parseInt(field.id.split("-")[1]);
        if (typeEl.value === "passport") {
          passports.push({file, id, label: typeEl.options[typeEl.selectedIndex].text});
        } else if (typeEl.value === "id") {
          ids.push({file, id, label: typeEl.options[typeEl.selectedIndex].text});
        } else {
          others.push({file, id, label: typeEl.options[typeEl.selectedIndex].text});
        }
      }

      // Progress bar setup
      let progress = 0;
      const totalSteps = passports.length + ids.length + others.length;
      const progressWrapper = document.getElementById("progressWrapper");
      const progressBar = document.getElementById("progressBar");
      progressWrapper.classList.remove("hidden");
      progressBar.style.width = "0%";

      // --- PAGE 1: Passport and ID images ---
      pdf.setFontSize(16);
      pdf.text("Uploaded Documents", 10, 15);
      let y = 25;
      let marginX = 10;
      let pageW = pdf.internal.pageSize.getWidth();
      let maxImgH = 45;
      let imgGap = 6;
      // --- PASSPORTS ---
      if (passports.length > 0) {
        pdf.setFontSize(13);
        pdf.text("Passport Photos:", marginX, y);
        y += 5;
        // Arrange horizontally, scale for mobile (fit up to 4 per row, wrap if more)
        let imgW = 35, imgH = 45;
        let perRow = Math.floor((pageW - 2 * marginX + imgGap) / (imgW + imgGap));
        perRow = Math.max(1, Math.min(4, perRow));
        let x = marginX;
        let rowY = y;
        for (let i = 0; i < passports.length; ++i) {
          let {file, id} = passports[i];
          let imgDataUrl = croppedImages[id] ? croppedImages[id] : await toBase64(file);
          pdf.addImage(imgDataUrl, "JPEG", x, rowY, imgW, imgH);
          x += imgW + imgGap;
          // Wrap to next row if needed
          if ((i + 1) % perRow === 0) {
            x = marginX;
            rowY += imgH + imgGap + 5;
          }
          progress += 1;
          progressBar.style.width = (progress * 100 / totalSteps) + "%";
        }
        y = rowY + imgH + imgGap;
      }
      // --- IDS ---
      if (ids.length > 0) {
        pdf.setFontSize(13);
        pdf.text("ID Images:", marginX, y);
        y += 5;
        // Arrange horizontally, scale for mobile (fit up to 2-3 per row)
        // Use 75% of the A4 page width for each image
        let imgW = pageW * 0.75;
        let imgH = imgW * 0.7; // maintain aspect ratio (approx 70% height of width)
        let perRow = Math.floor((pageW - 2 * marginX + imgGap) / (imgW + imgGap));
        perRow = Math.max(1, Math.min(3, perRow));
        let x = marginX;
        let rowY = y;
        for (let i = 0; i < ids.length; ++i) {
          let {file, id} = ids[i];
          let imgDataUrl = croppedImages[id] ? croppedImages[id] : await toBase64(file);
          pdf.addImage(imgDataUrl, "JPEG", x, rowY, imgW, imgH);
          x += imgW + imgGap;
          if ((i + 1) % perRow === 0) {
            x = marginX;
            rowY += imgH + imgGap + 3;
          }
          progress += 1;
          progressBar.style.width = (progress * 100 / totalSteps) + "%";
        }
        y = rowY + imgH + imgGap;
      }

      // Copyright notice (bottom center)
      addCopyrightNotice(pdf);

      // --- OTHERS: Each on its own page ---
      for (let i = 0; i < others.length; ++i) {
        if (i > 0 || passports.length > 0 || ids.length > 0) pdf.addPage();
        let {file, id, label} = others[i];
        pdf.setFontSize(14);
        pdf.text(label, 10, 20);
        let yStart = 30;
        if (file.type.includes("image")) {
          // Fit image to page (with margin), keeping aspect ratio
          let imgDataUrl = croppedImages[id] ? croppedImages[id] : await toBase64(file);
          let pageW = pdf.internal.pageSize.getWidth();
          let pageH = pdf.internal.pageSize.getHeight();
          let maxW = pageW - 20, maxH = pageH - 60;
          // Load image to get its aspect
          await new Promise((resolve) => {
            let img = new window.Image();
            img.onload = function() {
              let w = img.width, h = img.height;
              let scale = Math.min(maxW / w, maxH / h, 1);
              let drawW = w * scale, drawH = h * scale;
              let x = (pageW - drawW) / 2;
              let y = yStart;
              pdf.addImage(imgDataUrl, "JPEG", x, y, drawW, drawH);
              resolve();
            };
            img.src = imgDataUrl;
          });
        } else {
          // Just show file name
          pdf.setFontSize(12);
          pdf.text(`Attached file: ${file.name}`, 10, yStart);
        }
        addCopyrightNotice(pdf);
        progress += 1;
        progressBar.style.width = (progress * 100 / totalSteps) + "%";
      }

      pdf.save(fileName + ".pdf");
      progressWrapper.classList.add("hidden");
    }

    // Add copyright notice at the bottom of the current page
    function addCopyrightNotice(pdf) {
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      pdf.setFontSize(8);
      pdf.setTextColor(120,120,120);
      const text = "© Godfrey Mono - 0712220782";
      const textWidth = pdf.getTextWidth(text);
      pdf.text(text, (pageW - textWidth) / 2, pageH - 8, {align: "center"});
      pdf.setTextColor(0,0,0);
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }


    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    if (mobileMenuBtn && mobileMenu) {
      mobileMenuBtn.addEventListener("click", () => {
        mobileMenu.classList.toggle("hidden");
      });
    }

    // CropperJS integration
    const cropModal = document.getElementById("cropModal");
    const cropperImage = document.getElementById("cropperImage");
    const cancelCropBtn = document.getElementById("cancelCropBtn");
    const applyCropBtn = document.getElementById("applyCropBtn");

    function openCropModal(fieldId) {
      currentCropFieldId = fieldId;
      const previewImg = document.getElementById(`preview-${fieldId}`);
      if (!previewImg || previewImg.classList.contains("hidden")) return;

      // Find the type select element inside this field
      let aspectRatio = NaN;
      const fieldDiv = document.getElementById(`field-${fieldId}`);
      if (fieldDiv) {
        const typeSelect = fieldDiv.querySelector("select");
        if (typeSelect) {
          const fieldType = typeSelect.value;
          if (fieldType === "passport") {
            // Portrait: 35mm x 45mm (width/height)
            aspectRatio = 35 / 45;
          } else if (fieldType === "id") {
            // Landscape: 85.6mm x 54mm (credit card)
            aspectRatio = 85.6 / 54;
          } else {
            aspectRatio = NaN;
          }
        }
      }

      cropperImage.src = previewImg.src;
      cropModal.classList.remove("hidden");

      // Wait a tick for image to load before initializing cropper
      setTimeout(() => {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        cropper = new Cropper(cropperImage, {
          viewMode: 1,
          aspectRatio: aspectRatio,
          autoCropArea: 1,
          responsive: true,
          background: false,
        });
      }, 100);
    }

    cancelCropBtn.addEventListener("click", () => {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      cropModal.classList.add("hidden");
      currentCropFieldId = null;
      cropperImage.src = "";
    });

    applyCropBtn.addEventListener("click", () => {
      if (!cropper || currentCropFieldId === null) return;
      const canvas = cropper.getCroppedCanvas();
      if (canvas) {
        const croppedDataUrl = canvas.toDataURL("image/jpeg");
        croppedImages[currentCropFieldId] = croppedDataUrl;

        // Update preview image
        const previewImg = document.getElementById(`preview-${currentCropFieldId}`);
        previewImg.src = croppedDataUrl;

        // Clean up and close modal
        cropper.destroy();
        cropper = null;
        cropModal.classList.add("hidden");
        currentCropFieldId = null;
        cropperImage.src = "";
      }
    });
  </script>
</body>
</html>
