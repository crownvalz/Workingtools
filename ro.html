<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Barcode Scanner</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { text-align: center; color: #333; }
    #video { width: 100%; max-width: 400px; border: 2px solid #333; border-radius: 8px; display: block; margin: 0 auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #333; color: #fff; }
    button { padding: 10px 20px; margin-top: 10px; background: #333; color: #fff; border: none; border-radius: 6px; cursor: pointer; display: block; margin-left: auto; margin-right: auto; }
    button:hover { background: #555; }
</style>
</head>
<body>

<h1>Asset Barcode Scanner</h1>

<video id="video" autoplay></video>
<button id="exportBtn">Export to CSV</button>

<table id="scannedTable">
    <thead>
        <tr>
            <th>#</th>
            <th>Barcode</th>
            <th>Timestamp</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    const scannedData = [];
    const video = document.getElementById('video');
    const tableBody = document.querySelector('#scannedTable tbody');

    const codeReader = new ZXing.BrowserBarcodeReader();

    async function startScanner() {
        try {
            const videoInputDevices = await codeReader.listVideoInputDevices();
            const rearCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('back')) || videoInputDevices[0];

            codeReader.decodeFromVideoDevice(rearCamera.deviceId, 'video', (result, err) => {
                if (result) addScanned(result.text);
            });
        } catch (err) {
            alert('Error accessing camera: ' + err);
            console.error(err);
        }
    }

    function addScanned(code) {
        // Avoid duplicate scans
        if (scannedData.some(item => item.code === code)) return;

        const timestamp = new Date().toLocaleString();
        scannedData.push({ code, timestamp });

        const row = document.createElement('tr');
        row.innerHTML = `<td>${scannedData.length}</td><td>${code}</td><td>${timestamp}</td>`;
        tableBody.appendChild(row);
    }

    function exportToCSV() {
        if (!scannedData.length) return alert("No data to export!");

        const csvContent = "data:text/csv;charset=utf-8,"
            + ["#", "Barcode", "Timestamp"].join(",") + "\n"
            + scannedData.map((item, i) => `${i+1},${item.code},${item.timestamp}`).join("\n");

        const link = document.createElement('a');
        link.href = encodeURI(csvContent);
        link.download = `scanned_assets_${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    startScanner();
</script>

</body>
</html>
